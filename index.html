<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes">
　<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
　<meta name="theme-color" content="#000000">
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"
  >
  
　<link rel="manifest" href="manifest.webmanifest">

  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <link rel="icon" href="icons/icon-180.png">
  
  <title>Drive Slideshow</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #000; color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
    }
    #stage {
      position: fixed; inset: 0; overflow: hidden; background: #000;
      display: grid; place-items: center;
      cursor: none;
    }
    .layer {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      opacity: 0; transition: opacity 1000ms ease;
      background: #000;
    }
    .layer.show { opacity: 1; }
    img {
      max-width: 100vw; max-height: 100vh;
      width: auto; height: auto;
      object-fit: contain; image-rendering: auto;
      background: #000;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
    }
    #hud {
      position: absolute; right: 12px; bottom: 10px; left: 12px;
      display: flex; justify-content: space-between; align-items: center;
      opacity: .0; transition: opacity .3s;
      font-size: 12px; color: rgba(255,255,255,.8);
      pointer-events: none;
    }
    #stage:hover #hud { opacity: .9; }
    .pill {
      background: rgba(0,0,0,.45);
      padding: 6px 10px; border-radius: 999px;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,.6);
      display: inline-block; margin-left: 6px;
    }
    .dot.on { background: #fff; }
    #hint {
      position: absolute; top: 12px; left: 12px;
      font-size: 12px; color: rgba(255,255,255,.6);
      background: rgba(0,0,0,.35); padding: 6px 10px; border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="stage">
    <div id="layerA" class="layer"></div>
    <div id="layerB" class="layer"></div>
    <div id="hint">タップで全画面 / 2本指で解除（ガイド使用時）</div>
    <div id="hud">
      <div class="pill">新しい写真ほど表示頻度↑</div>
      <div class="pill" id="status">—</div>
    </div>
  </div>

  <script>
    // ====== 設定 ======
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyK7JT5E6ctMZL0onVeocYaquszf7e1eZk2scOhhCy_H4gQsp1mOXtBAIrXz6br_LY/exec'; // ★GASの実行URL
    const SLIDE_MS = 8000;   // 1枚の表示時間
    const FADE_MS  = 1000;   // フェード時間
    const HALF_LIFE_HOURS = 6; // 新しさ重み付けの半減期（短いほど新着を強く優遇）
    const SHUFFLE_BATCH = 20; // 一度に候補に乗せる枚数（重み抽選の母集団上限）

    const layerA = document.getElementById('layerA');
    const layerB = document.getElementById('layerB');
    const statusEl = document.getElementById('status');
    let currentLayer = layerA;
    let nextLayer = layerB;
    let items = []; // {url, updatedAt, ...}
    let timer = null;
    let running = true;
    
    // ★ 追加: ループ管理
    let loopHandle = null;
    let inFlight = false;   // 遷移の同時実行防止
    let lastSwapAt = 0;     // 最後に画像が画面に出た時刻（ms）

    function status(msg) { statusEl.textContent = msg; }

    async function fetchList() {
    status('読み込み中…');

    // 15秒タイムアウト
    const ctrl = new AbortController();
    const to = setTimeout(() => ctrl.abort(), 15000);

    try {
      const res = await fetch(`${API_BASE}?fn=list`, {
        cache: 'no-store',
        signal: ctrl.signal
      });

      // ステータス非200でも本文をログ
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        console.error('list non-OK', res.status, text);
        status(`読み込み失敗 (${res.status})`);
        return;
      }

      let json;
      try {
        json = await res.json();
      } catch (e) {
        const text = await res.text().catch(()=> '');
        console.error('JSON parse error. body=', text);
        status('JSON解析エラー');
        return;
      }

      items = Array.isArray(json.items) ? json.items : [];
      if (!items.length) {
        status('画像が見つかりません（フォルダ/権限を確認）');
        return;
      }
      status(`画像 ${items.length} 枚 / 更新 ${new Date(json.now).toLocaleString()}`);
    } catch (e) {
      console.error('fetch list error', e);
      status(e.name === 'AbortError' ? 'タイムアウト' : '通信エラー');
    } finally {
      clearTimeout(to);
    }
  }

    function status(msg) { statusEl.textContent = msg; }

    // 新しさ優遇の重み抽選：重み = exp(-(経過時間)/tau)
    function pickNextWeighted() {
      if (!items.length) return null;
      const now = Date.now();
      const tau = HALF_LIFE_HOURS * 3600 * 1000 / Math.log(2); // 半減期→時定数
      const pool = items.slice(0, Math.min(items.length, SHUFFLE_BATCH)); // 先頭は新しい順
      const weights = pool.map(it => {
        const age = Math.max(0, now - new Date(it.updatedAt).getTime());
        return Math.exp(-age / tau);
      });
      const sum = weights.reduce((a,b)=>a+b,0);
      let r = Math.random() * sum;
      for (let i = 0; i < pool.length; i++) {
        r -= weights[i];
        if (r <= 0) return pool[i];
      }
      return pool[pool.length - 1];
    }

async function preload(url) {
    const ctrl = new AbortController();
    const to = setTimeout(() => ctrl.abort(), 15000);
    try {
      const res = await fetch(url, { cache: 'no-store', signal: ctrl.signal });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} ${text?.slice(0,200)}`);
      }
      let payload;
      try {
        payload = await res.json();
      } catch (e) {
        const text = await res.text().catch(()=> '');
        throw new Error(`JSON解析失敗 ${text?.slice(0,200)}`);
      }
      if (payload?.error) {
        // エラー本文をそのまま可視化
        throw new Error(`img64 error: ${payload.error}`);
      }
      const mime = payload?.mime || 'image/jpeg';
      const b64  = payload?.data;
      if (!b64) throw new Error('data欠落');

      const src = `data:${mime};base64,${b64}`;
      const img = new Image();
      img.decoding = 'async';
      img.src = src;
      await new Promise((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = () => reject(new Error('img onerror'));
        setTimeout(()=> resolve(), 0);
      });
      return img;
    } finally {
      clearTimeout(to);
    }
  }

  async function showNext() {
    if (inFlight) return;       // ★ 二重起動ガード
    inFlight = true;
    try {
      const it = pickNextWeighted();
      if (!it) { status('候補がありません'); return; }

      // どのURLで落ちてるか一緒に表示
      status(`読み込み: ${it.name || ''}\n${it.url}`);

      const img = await preload(it.url);

      nextLayer.innerHTML = '';
      nextLayer.appendChild(img);
      nextLayer.classList.add('show');
      currentLayer.classList.remove('show');
      [currentLayer, nextLayer] = [nextLayer, currentLayer];
      // この瞬間から表示時間カウント開始
      lastSwapAt = Date.now();
      status('');
    } catch (e) {
      console.error('showNext error', e);
      status(`読み込みエラー: ${String(e).slice(0,300)}`);
    }
  }
  
  // ★ 追加: 次の遷移を予約（setIntervalをやめる）
  function scheduleNext(afterMs) {
    if (loopHandle) clearTimeout(loopHandle);
    loopHandle = setTimeout(async () => {
        if (!running) {
        // 一時停止中は短い間隔で再チェック
        scheduleNext(500);
        return;
        }

        // まだ最低表示時間に満たない場合は延長
        const elapsed = Date.now() - lastSwapAt;
        if (elapsed < SLIDE_MS) {
            scheduleNext(SLIDE_MS - elapsed);
            return;
        }

        await showNext();
        // 次回も「画面に出してから」SLIDE_MS後
        scheduleNext(SLIDE_MS);
    }, Math.max(0, afterMs));
　}

    function startLoop() {
      if (timer) clearInterval(timer);
      timer = setInterval(() => { if (running) showNext(); }, SLIDE_MS);
    }

    // 全画面切替（iPhone Safari）
    async function toggleFullscreen() {
      const el = document.documentElement;
      try {
        if (!document.fullscreenElement) {
          if (el.requestFullscreen) await el.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      } catch (e) { /* ignore */ }
    }

    // 初期化
    (async () => {
      await fetchList();
      if (!items.length) return;

      // 最初の1枚をすぐ表示
      await showNext();
      currentLayer.classList.add('show');
      //startLoop();
      scheduleNext(SLIDE_MS);

      // 5分おきに最新リストを再取得（新規ファイル追加を拾う）
      setInterval(fetchList, 5 * 60 * 1000);
    })();

    // タップでフルスクリーン
    document.getElementById('stage').addEventListener('click', () => toggleFullscreen());
    // 2本指タップで一時停止/再開（ガイド中の簡易操作）
    let lastTouchCount = 0;
    window.addEventListener('touchstart', (ev) => {
      if (ev.touches.length === 2) {
        running = !running;
        status(running ? '再開' : '一時停止');
        setTimeout(()=>status(''),1500);
      }
      lastTouchCount = ev.touches.length;
    }, {passive:true});
  </script>
</body>
</html>
